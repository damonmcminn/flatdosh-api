{"version":3,"sources":["../../es6/expense/controller.js"],"names":[],"mappings":"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","file":"es6/expense/controller.js","sourcesContent":["import {Router} from 'express';\nimport Expense from './model';\nimport {isError} from 'js-type-check';\nimport uuid from 'node-uuid';\n\nconst router = Router();\n\nexport default router;\n\nfunction findAll(req, res, next) {\n\n  let {group} = req.params;\n\n  Expense.all(group).then(expenses => {\n    res.json(expenses);\n  });\n\n}\n\nfunction insert(req, res, next) {\n\n  // need to check if spender in group\n  let spender = req.body.spender;\n\n  // user == the user\n  // shared == the user with whom user shares a bank account\n  let user = req.user.id;\n\n  // saving expense on behalf of another member?\n  let onBehalfOf = (spender !== user && spender !== req.user.shared);\n\n  // false, undefined or a members email\n  let shared = onBehalfOf ? false : req.user.shared;\n\n  // if share undefined|false, filter it from array\n  let people = [user, shared].filter(email => email);\n  let timestamp = new Date();\n  let amount = req.body.amount/people.length;\n\n  // validate group against req.user.groups\n  let group = req.body.group;\n\n  let expenses = people.map(email => {\n    return {\n      amount,\n      creator: user,\n      description: req.body.description,\n      email,\n      group,\n      timestamp\n    }\n  });\n\n  let shareId = uuid.v4();\n  expenses.forEach(expense => {\n    if (shared) {\n      expense.shareId = shareId;\n    }\n    if (onBehalfOf) {\n      expense.email = spender;\n    }\n  });\n\n  let validatedExpense = Expense.validate(expenses[0]);\n\n  return isError(validatedExpense) ? next(validatedExpense) : \n    Expense.insert(expenses).then(result => {\n      return result.errors === 0 ? res.json(result) : next(result);\n    })\n    // errors not handled above\n    .catch(err => next(err));\n}\n\nfunction destroy(req, res, next) {\n\n  let user = req.user.id;\n  let expenses = req.body;\n\n  Expense.destroy(user, expenses)\n    .then(result => {\n      res.json({deleted: expenses});\n    })\n    .catch(next);\n\n}\n\nrouter.get('/:group', findAll);\nrouter.post('/', insert);\nrouter.delete('/', destroy);\n"]}