{"version":3,"sources":["../../es6/balance/controller.js"],"names":[],"mappings":";;;;;;;;sBAAqB,SAAS;;uBACV,kBAAkB;;;;uBAChB,eAAe;;sBACf,OAAO;;qBAEX,gBAAgB;;;;AAElC,IAAM,MAAM,GAAG,QAPP,MAAM,EAOS,CAAC;;qBAET,MAAM;;AACrB,MAAM,CAAC,GAAG,CAAC,SAAS,EAAE,WAAW,CAAC,CAAC;;AAEnC,SAAS,WAAW,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,EAAE;MAE9B,MAAM,GAAI,GAAG,CAAC,IAAI,CAAlB,MAAM;MACN,KAAK,GAAI,GAAG,CAAC,MAAM,CAAnB,KAAK;;;;AAIV,qBAAM,OAAO,CAAC,KAAK,CAAC,CACjB,SAAS,CAAC,QAjBP,CAAC,CAiBQ,KAAK,CAAC,UAAU,CAAC,CAAC,MAAM,CAAC,QAjBlC,CAAC,CAiBmC,GAAG,CAAC,QAjBxC,CAAC,CAiByC,GAAG,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,EACtE,UAAC,IAAI,EAAE,OAAO,EAAK;AACjB,WAAO,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC;GAC7C,CAAC,CACD,GAAG,EAAE,CACL,GAAG,CAAC,UAAA,GAAG,EAAI;AACV,WAAO,GAAG,CAAC,KAAK,CAAC,EAAC,GAAG,EAAE,GAAG,CAAC,QAAQ,CAAC,WAAQ,CAAC,CAAC,CAAC,EAAC,CAAC,CAAC;GACnD,CAAC,CACD,KAAK,CAAC,MAAM,CAAC,CACb,GAAG,CAAC,KAAK,CAAC,CACV,OAAO,EAAE,CACT,GAAG,CAAC,UAAA,CAAC,EAAI;AACR,WAAO,EAAC,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,EAAE,MAAM,EAAE,CAAC,CAAC,WAAW,CAAC,EAAC,CAAA;GAClD,CAAC,CACD,GAAG,SA/BG,IAAI,CA+BD,CACT,IAAI,CAAC,UAAA,OAAO,EAAI;;AAEf,QAAI,QAAQ,YAAA,CAAC;;AAEb,QAAI,OAAO,EAAE;;AACX,YAAI,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,UAAA,MAAM;iBAAI,MAAM,CAAC,MAAM;SAAA,CAAC,CAC7C,MAAM,CAAC,UAAC,IAAI,EAAE,IAAI;iBAAK,IAAI,GAAG,IAAI;SAAA,CAAC,CAAC;;AAEvC,YAAI,IAAI,GAAG,KAAK,GAAC,OAAO,CAAC,MAAM,CAAC;;AAEhC,gBAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,UAAA,MAAM,EAAI;AAC/B,iBAAO;AACL,gBAAI,EAAE,MAAM,CAAC,IAAI;AACjB,mBAAO,EAAE,MAAM,CAAC,MAAM;AACtB,gBAAI,EAAJ,IAAI;AACJ,eAAG,EAAE,IAAI,GAAG,MAAM,CAAC,MAAM;WAC1B,CAAC;SACH,CAAC,CACD,IAAI,CAAC,UAAC,CAAC,EAAC,CAAC;iBAAK,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC,IAAI,CAAC,WAAW,EAAE;SAAA,CAAC,CAAC;;KAC7D;AACD,OAAG,CAAC,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC,CAAC;GAC1B,CAAC,CAAC;CACN","file":"es6/balance/controller.js","sourcesContent":["import {Router} from 'express';\nimport Expense from '../expense/model';\nimport {isError} from 'js-type-check';\nimport {r, conn} from '../db';\n\nimport Group from '../group/model';\n\nconst router = Router();\n\nexport default router;\nrouter.get('/:group', getBalances);\n\nfunction getBalances(req, res, next) {\n\n  let {groups} = req.user;\n  let {group} = req.params\n\n  // validate group is in groups i.e. allowed\n\n  Group.members(group)\n    .outerJoin(r.table('expenses').filter(r.not(r.row.hasFields('deleted'))),\n      (user, expense) => {\n        return user('email').eq(expense('email'));\n    })\n    .zip()\n    .map(doc => {\n      return doc.merge({amt: doc('amount').default(0)});\n    })\n    .group('name')\n    .sum('amt')\n    .ungroup()\n    .map(x => {\n      return {name: x('group'), amount: x('reduction')}\n    })\n    .run(conn)\n    .then(results => {\n\n      let balances;\n\n      if (results) {\n        let total = results.map(result => result.amount)\n          .reduce((prev, curr) => prev + curr);\n\n        let each = total/results.length;\n\n        balances = results.map(result => {\n          return {\n            name: result.name,\n            balance: result.amount,\n            each,\n            owe: each - result.amount\n          };\n        })\n        .sort((a,b) => a.name.toLowerCase() > b.name.toLowerCase());\n      }\n      res.json(balances || []);\n    });\n}\n"]}