{"version":3,"sources":["../../es6/balance/model.js"],"names":[],"mappings":"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","file":"es6/balance/model.js","sourcesContent":["import {r, conn} from '../db';\nimport Group from '../group/model';\nimport settle from './settle';\n\nexport default {get, zero};\n\nfunction balances(group) {\n\n  return Group.members(group)\n  .outerJoin(r.table('expenses').filter(r.not(r.row.hasFields('deleted'))),\n    (user, expense) => {\n      return user('email').eq(expense('email'));\n  })\n  .zip()\n  .map(doc => {\n    return doc.merge({amt: doc('amount').default(0)});\n  })\n  .group('name')\n  .sum('amt')\n  .ungroup()\n  .map(x => {\n    return {name: x('group'), amount: x('reduction')}\n  });\n}\n\nfunction zero(group) {\n}\n\nfunction get(group) {\n\n  return balances(group)\n    .run(conn)\n    .then(results => {\n\n      let balances = buildBalances(results);\n\n      let settled = settle(balances, 'name', 'owed');\n\n      balances.forEach(bal => {\n\n        bal.debts = settled[bal.name] || [];\n\n      });\n\n      return balances;\n\n    });\n\n}\n\nfunction buildBalances(results) {\n\n  let balances;\n\n  if (results) {\n    let total = results.map(result => result.amount)\n      .reduce((prev, curr) => prev + curr);\n\n    // always round up to closest 1p\n    let each = Math.ceil((total/results.length)*100)/100;\n\n    balances = results.map(result => {\n\n      let owe = each - result.amount;\n      let owed = result.amount - each;\n\n      return {\n        name: result.name,\n        balance: result.amount,\n        each,\n        owe,\n        owed \n      };\n    })\n    .sort((a,b) => a.name.toLowerCase() > b.name.toLowerCase());\n  }\n\n  return balances || [];\n}\n"]}